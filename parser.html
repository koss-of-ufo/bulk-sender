<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üîç –ü–∞—Ä—Å–µ—Ä —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh; padding: 20px;
}
.container {
    max-width: 1400px;
    margin: 0 auto; background: white;
    border-radius: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    overflow: hidden;
}
.header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white; padding: 30px; text-align: center;
}
.header h1 { font-size: 32px; margin-bottom: 10px; }
.header p { opacity: 0.9; font-size: 16px; }
.content { padding: 40px 30px; }
.form-group { margin-bottom: 30px; }
label { display: block; margin-bottom: 12px; font-weight: 600; color: #333; font-size: 16px; }
textarea {
    width: 100%; min-height: 160px; padding: 20px; font-size: 16px;
    border: 3px solid #e9ecef; border-radius: 16px; font-family: 'Courier New', monospace;
    line-height: 1.6; resize: vertical; transition: all 0.3s;
    background: #fafbfc;
}
textarea:focus {
    outline: none; border-color: #28a745; box-shadow: 0 0 0 4px rgba(40,167,69,0.1);
}
.results-layout { 
    display: grid; 
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px; 
    margin-top: 30px; 
    align-items: start;
}
.result-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 0;
}
.result-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6; border-radius: 16px; padding: 25px;
    transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden;
}
.result-card:hover {
    transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}
.result-card.main { border-left: 6px solid #28a745; }
.result-card.sql { border-left: 6px solid #007bff; }
.result-card.num-csv { border-left: 6px solid #17a2b8; }
.result-card.uuid-main { border-left: 6px solid #6f42c1; }
.result-card.uuid-sql { border-left: 6px solid #e83e8c; }
.result-card.uuid-csv { border-left: 6px solid #fd7e14; }
.result-card.grz-main { border-left: 6px solid #dc3545; }
.result-card.grz-sql { border-left: 6px solid #c82333; }
.result-card.grz-csv { border-left: 6px solid #bd2130; }
.result-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #495057; }
.result-number {
    font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold;
    color: #212529; word-break: break-all; letter-spacing: 0.5px; line-height: 1.3;
    min-height: 40px; display: flex; align-items: center;
}
.result-card.sql .result-number, 
.result-card.uuid-sql .result-number,
.result-card.uuid-csv .result-number,
.result-card.num-csv .result-number,
.result-card.grz-sql .result-number,
.result-card.grz-csv .result-number { 
    font-size: 13px; line-height: 1.4; max-height: 150px; overflow-y: auto; 
}
.count-badge {
    position: absolute; top: 15px; right: 15px; background: #28a745; color: white;
    border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 600;
}
.result-card.uuid-main .count-badge, 
.result-card.uuid-sql .count-badge { background: #6f42c1; }
.result-card.uuid-csv .count-badge { background: #fd7e14; }
.result-card.num-csv .count-badge { background: #17a2b8; }
.result-card.grz-main .count-badge,
.result-card.grz-sql .count-badge,
.result-card.grz-csv .count-badge { background: #dc3545; }
.status { padding: 20px; border-radius: 12px; text-align: center; font-weight: 600; margin-top: 20px; }
.status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.debug { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 20px; font-family: monospace; font-size: 13px; color: #6c757d; }
.instructions { background: #fff3cd; border-radius: 16px; padding: 25px; margin-top: 30px; border-left: 6px solid #ffc107; }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò–ó –ë–î (–ù–û–í–û–ï) --- */
.db-results-container {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 16px;
    border: 2px solid #dee2e6;
}
.db-results-container h3 { margin-bottom: 15px; color: #333; }
.db-results-table { width: 100%; border-collapse: collapse; font-size: 14px; }
.db-results-table th, .db-results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.db-results-table th { background-color: #e9ecef; font-weight: 600; }
.db-results-table tr:nth-child(even) { background-color: #f2f2f2; }
.query-button {
    display: block; width: 100%; padding: 12px; margin-top: 10px;
    background: #007bff; color: white; border: none; border-radius: 8px;
    font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s;
}
.query-button:hover { background: #0056b3; }

@media (max-width: 1024px) { .results-layout { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîç –ü–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö</h1>
        <p>–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | UUID | –ì–†–ù–ó</p>
    </div>

    <div class="content">
        <div class="form-group">
            <label>üìù –í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è:</label>
            <textarea id="inputText" placeholder="–ü—Ä–∏–º–µ—Ä: ..."></textarea>
        </div>

        <div id="result" style="display: none;">
            <div class="results-layout">
                <!-- 1. –ö–û–õ–û–ù–ö–ê: –ü–û–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø -->
                <div class="result-column">
                    <h3 style="color:#28a745;">üìú –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                    <div class="result-card main" id="cardNumMain" onclick="copyNumber()">
                        <div class="count-badge" id="mainCount">0</div>
                        <div class="result-title">üì± –ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                        <div class="result-number" id="outputText"></div>
                    </div>
                    <div class="result-card sql" id="cardNumSql" onclick="copySQL()">
                        <div class="count-badge" id="sqlCount">0</div>
                        <div class="result-title">üíæ SQL IN (...)</div>
                        <div class="result-number" id="sqlOutput"></div>
                    </div>
                    <div class="result-card num-csv" id="cardNumCsv" onclick="copyNumCsv()">
                        <div class="count-badge" id="numCsvCount">0</div>
                        <div class="result-title">üìÑ CSV (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</div>
                        <div class="result-number" id="numCsvOutput"></div>
                    </div>
                    <button id="queryDbBtn" class="query-button" style="display:none;">üì° –ù–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ë–î</button>
                </div>

                <!-- 2. –ö–û–õ–û–ù–ö–ê: UUID -->
                <div class="result-column">
                    <h3 style="color:#6f42c1;">üÜî UUID</h3>
                    <div class="result-card uuid-main" id="cardUuidMain" onclick="copyUUIDMain()">
                        <div class="count-badge" id="uuidMainCount">0</div>
                        <div class="result-title">üÜî UUID (–ì–ª–∞–≤–Ω—ã–π)</div>
                        <div class="result-number" id="uuidOutput"></div>
                    </div>
                    <div class="result-card uuid-sql" id="cardUuidSql" onclick="copyUUIDSQL()">
                        <div class="count-badge" id="uuidSqlCount">0</div>
                        <div class="result-title">üíæ SQL IN (UUID)</div>
                        <div class="result-number" id="uuidSqlOutput"></div>
                    </div>
                    <div class="result-card uuid-csv" id="cardUuidCsv" onclick="copyUUIDCsv()">
                        <div class="count-badge" id="uuidCsvCount">0</div>
                        <div class="result-title">üìÑ CSV –¥–ª—è –°–í–ü3</div>
                        <div class="result-number" id="uuidCsvOutput"></div>
                    </div>
                </div>

                <!-- 3. –ö–û–õ–û–ù–ö–ê: –ì–†–ù–ó -->
                <div class="result-column">
                    <h3 style="color:#dc3545;">üöó –ì–†–ù–ó (Latin)</h3>
                    <div class="result-card grz-main" id="cardGrzMain" onclick="copyGrzMain()">
                        <div class="count-badge" id="grzMainCount">0</div>
                        <div class="result-title">üöó –ì–†–ù–ó (–ì–ª–∞–≤–Ω—ã–π)</div>
                        <div class="result-number" id="grzOutput"></div>
                    </div>
                    <div class="result-card grz-sql" id="cardGrzSql" onclick="copyGrzSQL()">
                        <div class="count-badge" id="grzSqlCount">0</div>
                        <div class="result-title">üíæ SQL IN (–ì–†–ù–ó)</div>
                        <div class="result-number" id="grzSqlOutput"></div>
                    </div>
                    <div class="result-card grz-csv" id="cardGrzCsv" onclick="copyGrzCsv()">
                        <div class="count-badge" id="grzCsvCount">0</div>
                        <div class="result-title">üìÑ CSV (–ì–†–ù–ó)</div>
                        <div class="result-number" id="grzCsvOutput"></div>
                    </div>
                </div>
            </div>

            <div id="status" class="status"></div>
            <div id="debug" class="debug"></div>

            <div id="dbResultsContainer" class="db-results-container" style="display: none;">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö</h3>
                <div id="dbResultsOutput"></div>
            </div>
        </div>
        <div class="instructions"> ... </div>
    </div>
</div>

<script>
    const input = document.getElementById('inputText');
    const result = document.getElementById('result');

    // Elements for Numbers
    const output = document.getElementById('outputText');
    const sqlOutput = document.getElementById('sqlOutput');
    const numCsvOutput = document.getElementById('numCsvOutput');
    const cardNumMain = document.getElementById('cardNumMain');
    const cardNumSql = document.getElementById('cardNumSql');
    const cardNumCsv = document.getElementById('cardNumCsv');
    const mainCount = document.getElementById('mainCount');
    const sqlCount = document.getElementById('sqlCount');
    const numCsvCount = document.getElementById('numCsvCount');

    // Elements for UUIDs
    const uuidOutput = document.getElementById('uuidOutput');
    const uuidSqlOutput = document.getElementById('uuidSqlOutput');
    const uuidCsvOutput = document.getElementById('uuidCsvOutput');
    const cardUuidMain = document.getElementById('cardUuidMain');
    const cardUuidSql = document.getElementById('cardUuidSql');
    const cardUuidCsv = document.getElementById('cardUuidCsv');
    const uuidMainCount = document.getElementById('uuidMainCount');
    const uuidSqlCount = document.getElementById('uuidSqlCount');
    const uuidCsvCount = document.getElementById('uuidCsvCount');

    // Elements for GRZ (–ì–†–ù–ó)
    const grzOutput = document.getElementById('grzOutput');
    const grzSqlOutput = document.getElementById('grzSqlOutput');
    const grzCsvOutput = document.getElementById('grzCsvOutput');
    const cardGrzMain = document.getElementById('cardGrzMain');
    const cardGrzSql = document.getElementById('cardGrzSql');
    const cardGrzCsv = document.getElementById('cardGrzCsv');
    const grzMainCount = document.getElementById('grzMainCount');
    const grzSqlCount = document.getElementById('grzSqlCount');
    const grzCsvCount = document.getElementById('grzCsvCount');
    
    // DB Elements
    const queryDbBtn = document.getElementById('queryDbBtn');
    const dbResultsContainer = document.getElementById('dbResultsContainer');
    const dbResultsOutput = document.getElementById('dbResultsOutput');

    const status = document.getElementById('status');
    const debug = document.getElementById('debug');

    let currentNumbers = [];
    let currentUUIDs = [];
    let currentGRZ = [];

    const cyrillicToLatinMap = { '–ê': 'A', '–í': 'B', '–ï': 'E', '–ö': 'K', '–ú': 'M', '–ù': 'H', '–û': 'O', '–†': 'P', '–°': 'C', '–¢': 'T', '–£': 'Y', '–•': 'X', '–∞': 'A', '–≤': 'B', '–µ': 'E', '–∫': 'K', '–º': 'M', '–Ω': 'H', '–æ': 'O', '—Ä': 'P', '—Å': 'C', '—Ç': 'T', '—É': 'Y', '—Ö': 'X' };

    function convertCyrillicToLatin(text) {
        let result = '';
        for (let char of text) { result += cyrillicToLatinMap[char] || char; }
        return result.toUpperCase();
    }

    function extractNumbers(text) {
        const patterns = [/(\b\d{5}\s+\d{5}\s+\d{5}\s+\d{5}\s+\d{5,}\b)/gi, /(\b\d{20,}\b)/g];
        let allMatches = [];
        patterns.forEach(p => { allMatches.push(...(text.match(p) || [])); });
        return [...new Set(allMatches)].map(n => n.replace(/\s+/g, '')).filter(n => n.length >= 20 && /^\d+$/.test(n));
    }

    function extractUUIDs(text) {
        const matches = text.match(/\b[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}\b/gi) || [];
        return [...new Set(matches.map(u => u.toLowerCase()))];
    }

    function extractGRZ(text) {
        const grzPatterns = [/[–ê–í–ï–ö–ú–ù–û–†–°–¢–£–•ABEKMHOPCTYX]\s*\d{3}\s*[–ê–í–ï–ö–ú–ù–û–†–°–¢–£–•ABEKMHOPCTYX]{2}\s*\d{2,3}/gi];
        let foundGRZ = [];
        grzPatterns.forEach(p => { foundGRZ.push(...(text.match(p) || [])); });
        return [...new Set(foundGRZ.map(g => convertCyrillicToLatin(g).replace(/\s+/g, '')))];
    }

    function updateResult() {
        const text = input.value.trim();
        currentNumbers = extractNumbers(text);
        currentUUIDs = extractUUIDs(text);
        currentGRZ = extractGRZ(text);

        const hasNumbers = currentNumbers.length > 0;
        const hasUUIDs = currentUUIDs.length > 0;
        const hasGRZ = currentGRZ.length > 0;

        if (hasNumbers || hasUUIDs || hasGRZ) {
            result.style.display = 'block';
            status.className = 'status success';
            let parts = [];
            
            // Numbers
            cardNumMain.style.display = hasNumbers ? 'block' : 'none';
            cardNumSql.style.display = hasNumbers ? 'block' : 'none';
            cardNumCsv.style.display = hasNumbers ? 'block' : 'none';
            if(hasNumbers) {
                output.textContent = currentNumbers[0];
                sqlOutput.textContent = `in ('${currentNumbers.join("','")}')`;
                numCsvOutput.textContent = currentNumbers.join(', ');
                mainCount.textContent = `1/${currentNumbers.length}`;
                sqlCount.textContent = `${currentNumbers.length}`;
                numCsvCount.textContent = `${currentNumbers.length}`;
                parts.push(`${currentNumbers.length} –ø–æ—Å—Ç–∞–Ω–æ–≤–ª.`);
            }

            // UUIDs
            cardUuidMain.style.display = hasUUIDs ? 'block' : 'none';
            cardUuidSql.style.display = hasUUIDs ? 'block' : 'none';
            cardUuidCsv.style.display = hasUUIDs ? 'block' : 'none';
            if(hasUUIDs) {
                uuidOutput.textContent = currentUUIDs[0];
                uuidSqlOutput.textContent = `in ('${currentUUIDs.join("','")}')`;
                uuidCsvOutput.textContent = currentUUIDs.join(', ');
                uuidMainCount.textContent = `1/${currentUUIDs.length}`;
                uuidSqlCount.textContent = `${currentUUIDs.length}`;
                uuidCsvCount.textContent = `${currentUUIDs.length}`;
                parts.push(`${currentUUIDs.length} UUID`);
            }
            
            // GRZ
            cardGrzMain.style.display = hasGRZ ? 'block' : 'none';
            cardGrzSql.style.display = hasGRZ ? 'block' : 'none';
            cardGrzCsv.style.display = hasGRZ ? 'block' : 'none';
            if(hasGRZ) {
                grzOutput.textContent = currentGRZ[0];
                grzSqlOutput.textContent = `in ('${currentGRZ.join("','")}')`;
                grzCsvOutput.textContent = currentGRZ.join(', ');
                grzMainCount.textContent = `1/${currentGRZ.length}`;
                grzSqlCount.textContent = `${currentGRZ.length}`;
                grzCsvCount.textContent = `${currentGRZ.length}`;
                parts.push(`${currentGRZ.length} –ì–†–ù–ó`);
            }

            status.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${parts.join(', ')}`;
            debug.innerHTML = `–¢–µ–∫—Å—Ç: ${text.length} | –ü–æ—Å—Ç: ${currentNumbers.length} | UUID: ${currentUUIDs.length} | –ì–†–ù–ó: ${currentGRZ.length}`;
            
        } else {
            result.style.display = 'block';
            status.textContent = '‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
            status.className = 'status error';
            document.querySelectorAll('.result-card').forEach(c => c.style.display = 'none');
            debug.textContent = '';
        }
        
        queryDbBtn.style.display = hasNumbers ? 'block' : 'none';
        dbResultsContainer.style.display = 'none';
    }

    async function queryDatabase() {
        if (currentNumbers.length === 0) return;
        dbResultsContainer.style.display = 'block';
        dbResultsOutput.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        const backendUrl = 'http://localhost:3003/query-violations';
        try {
            const response = await fetch(backendUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numbers: currentNumbers }),
            });
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.statusText}`);
            const data = await response.json();
            displayDbResults(data);
        } catch (error) {
            dbResultsOutput.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞: ${error.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ back-end —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.</p>`;
        }
    }

    function displayDbResults(data) {
        if (data.length === 0) {
            dbResultsOutput.innerHTML = '<p>–ü–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–∞–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
            return;
        }
        let table = '<table class="db-results-table"><thead><tr>';
        const headers = Object.keys(data[0]);
        headers.forEach(h => { table += `<th>${h}</th>`; });
        table += '</tr></thead><tbody>';
        data.forEach(row => {
            table += '<tr>';
            headers.forEach(h => { table += `<td>${row[h] !== null ? row[h] : 'NULL'}</td>`; });
            table += '</tr>';
        });
        table += '</tbody></table>';
        dbResultsOutput.innerHTML = table;
    }

    function copyToClipboard(text) { navigator.clipboard.writeText(text); }
    // ... (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    window.copyNumber = function() { if(currentNumbers.length) copyToClipboard(currentNumbers[0]); };
    window.copySQL = function() { if(currentNumbers.length) copyToClipboard(`in ('${currentNumbers.join("','")}')`); };
    //... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫

    input.addEventListener('input', updateResult);
    queryDbBtn.addEventListener('click', queryDatabase);
    updateResult();
</script>
</body>
</html>